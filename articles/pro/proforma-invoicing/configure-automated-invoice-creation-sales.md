---
title: 设置发票自动创建
description: 本主题提供关于设置和配置形式发票的自动创建的信息。
author: rumant
ms.date: 04/05/2021
ms.topic: article
ms.reviewer: johnmichalak
ms.author: rumant
ms.openlocfilehash: 027cc711d53c7dd8512e6ef416b54e320357dd26
ms.sourcegitcommit: c0792bd65d92db25e0e8864879a19c4b93efb10c
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 04/14/2022
ms.locfileid: "8584079"
---
# <a name="set-up-automatic-invoice-creation"></a>设置发票自动创建 
 
_**适用于：** 精简部署 - 估价交易开单，基于资源/非库存场景的 Project Operations_

您可以在 Dynamics 365 Project Operations 中配置自动创建发票。 系统基于每个项目合同和合同子项的发票计划创建草稿估价发票。 发票计划在合同子项级别配置。 合同中的每一行可以有不同的发票计划，也可以在合同的每一行中包含相同的发票计划。

在您创建发票时，系统始终会为每个项目合同创建至少一个发票。 在某些情况下，可能创建多个发票。 例如，如果合同有多个客户，则将创建与该项目合同中具有可计费交易需要开票的客户数量相同的发票数量。

## <a name="understand-how-transactions-are-included-on-an-invoice"></a>了解发票上如何包含交易 

在某些情况下，每个基于项目的合同子项会指定单独的发票计划。 例如，Adatum 合同的实施服务具有以下合同子项：

- 具有两个手动创建的里程碑的固定价格的原型工作。
- 将在星期一每两周计费一次的包括时间的实施服务。
- 产生的需要在每月的第一个星期一按月计费的支出。

在这两个明细项目中定义的发票计划如下表所示：

| 合同子项 | 发票运行日期 | 交易截止日期 | 里程碑日期 | 里程碑金额 |
| --- | --- | --- | --- | --- |
| 原型工作 | 10 月 5 日，星期一 | - | 10 月 5 日，星期一 | 5000 USD |
| - | 11 月 3 日，星期二 | - | 11 月 3 日，星期二 | 12,000 USD |
| 实施工作 | 10 月 5 日，星期一 | 10 月 4 日，星期日 | - | - |
| - | 10 月 19 日，星期一 | 10 月 18 日，星期日 | - | - |
| - | 11 月 2 日，星期一 | 11 月 1 日，星期日 | - | - |
| - | 11 月 16 日，星期一 | 11 月 15 日，星期日 | - | - |
| 产生的支出 | 10 月 5 日，星期一 | 10 月 4 日，星期日 | - | - |
| - | 11 月 2 日，星期一 | 11 月 1 日，星期日 | - | - |

在此示例中，当自动开票在以下时间运行时：

- **10 月 4 日或之前的任何日期**：不会为此合同生成发票，因为这些合同子项中每个合同子项的 **发票计划** 表都不会调出“10 月 4 日，星期日”作为发票运行日期。
- **10 月 5 日，星期一**：为以下各项生成一个发票：

    - 包括里程碑的原型工作（如果其标记为 **可开票**）。
    - 包括在交易截止日期“10 月 4 日，星期日”之前创建的所有时间交易且标记为 **可开票** 的实施工作。
    - 包括在交易截止日期“10 月 4 日，星期日”之前创建的所有支出交易且标记为 **可开票** 的产生的支出。
  
- **10 月 6 日或 10 月 19 日之前的任何日期**：不会为此合同生成发票，因为这些合同子项中每个合同子项的 **发票计划** 表都不会调出“10 月 6 日或 10 月 19 日之前的任何日期”作为发票运行日期。
- **10 月 19 日，星期一**：将为包括在交易截止日期“10 月 18 日，星期日”之前创建的所有时间交易且标记为 **可开票** 的实施工作生成一个发票。
- **11 月 2 日，星期一**：为以下各项生成一个发票：

    - 包括在交易截止日期“11 月 1 日，星期日”之前创建的所有时间交易且标记为 **可开票** 的实施工作。
    - 包括在交易截止日期“11 月 1 日，星期日”之前创建的所有支出交易且标记为 **可开票** 的产生的支出。

- **11 月 3 日，星期二**：将为包括 12000 美元里程碑的原型工作生成一个发票（如果其标记为 **可开票**）。

## <a name="configure-automatic-invoicing"></a>配置自动开票

完成以下步骤配置自动化发票运行。

1. 在 **Project Operations** 中，转到 **设置** > **定期发票设置**。
2. 创建一个批处理作业，将其命名为 **Project Operations 创建发票**。 此批处理作业的名称中必须包含词语“创建发票”。
3. 在 **作业类型** 字段中，选择 **无**。 默认情况下，**每天频率** 和 **可用** 字段设置为 **是**。
4. 选择 **运行工作流**。 在 **查找记录** 对话框中，您将看到三个工作流：

- ProcessRunCaller
- ProcessRunner
- UpdateRoleUtilization

5. 选择 **ProcessRunCaller**，然后选择 **添加**。
6. 在下一个对话框中，选择 **确定**。 **Sleep** 工作流后是 **Process** 工作流。 

> [!NOTE]
> 可以选择步骤 5 中的 **ProcessRunner**。 然后，当您选择 **确定** 时，**Process** 工作流后是 **Sleep** 工作流。

**ProcessRunCaller** 和 **ProcessRunner** 工作流创建发票。 **ProcessRunCaller** 调用 **ProcessRunner**。 **ProcessRunner** 是真正创建发票的工作流。 此工作流经过必须为其创建发票的所有合同子项，然后为这些子项创建发票。 为了确定必须为其创建发票的合同子项，作业将查看合同子项的发票运行日期。 如果属于一个合同的合同子项具有同一个发票运行日期，将把交易合并到一张具有两项发票明细的发票中。 如果没有需要为其创建发票的交易，作业将跳过发票创建。

**ProcessRunner** 完成运行之后，将调用 **ProcessRunCaller**，提供结束时间，然后关闭。 然后，**ProcessRunCaller** 启动一个从指定结束日期开始运行 24 小时的计时器。 此计时器结束时，将关闭 **ProcessRunCaller**。

用于创建发票的批处理作业是周期性作业。 如果多次运行此批处理流程，将创建多个作业实例，并导致出错。 因此，仅应启动此批处理流程一次，之后仅在它停止运行时重新启动。

> [!NOTE]
> Project Operations 中的批处理开票仅为按发票计划配置的项目合同子项运行。 必须为采用固定价格记帐方法的合同子项配置里程碑。 将需要为采用时间和材料记帐方法的项目合同子项设置基于日期的发票计划。


[!INCLUDE[footer-include](../../includes/footer-banner.md)]

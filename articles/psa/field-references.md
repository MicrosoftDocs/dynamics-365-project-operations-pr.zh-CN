---
title: 向价格设置和交易实体添加自定义字段
description: 此主题介绍如何向价格设置和交易实体添加自定义字段。
author: Rumant
manager: kfend
ms.custom:
- dyn365-projectservice
ms.date: 10/01/2020
ms.topic: article
ms.service: business-applications
ms.author: rumant
audience: Admin
search.audienceType:
- admin
- customizer
- enduser
search.app:
- D365PS
- ProjectOperations
ms.openlocfilehash: e1a8d6319788ee73e0e2837a47cba89108c32572
ms.sourcegitcommit: fa32b1893286f20271fa4ec4be8fc68bd135f53c
ms.translationtype: HT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/15/2021
ms.locfileid: "5275302"
---
# <a name="add-custom-fields-to-price-setup-and-transactional-entities"></a>向价格设置和交易实体添加自定义字段 

[!include [banner](../includes/psa-now-project-operations.md)]

此主题假设您已完成了[创建自定义字段和实体](create-custom-fields-entities.md)主题中的过程。 如果尚未完成这些过程，请回去完成，然后回到此主题。 

此主题中的过程将显示如何把所需自定义字段引用添加到实体和用户界面 (UI) 元素，如窗体和视图。

## <a name="add-custom-pricing-dimension-fields"></a>添加自定义定价维度字段 
创建自定义字段和实体之后，下一步是通过创建引用字段让价格设置和交易实体可以识别任何自定义实体或选项集。 根据定价维度列表中包含的是选项集维度和/或实体维度，相应执行 **基于选项集的自定义定价维度** 和/或 **基于实体的自定义定价维度**。

### <a name="option-set-based-custom-pricing-dimensions"></a>基于选项集的自定义定价维度
如果自定义定价维度基于选项集，请将其作为字段添加到关键 Project Service 实体。 在以下过程中，**资源工作位置** 和 **资源工作时间** 用作基于选项集的定价维度。 首先必须将其作为字段添加到定价维度 **角色价格** 和 **角色价格加价**。

1. 在 Project Service Automation (PSA) 中，单击 **设置** > **解决方案**，然后双击 **\<your organization name> 定价维度**。 
2. 在解决方案资源管理器中左侧导航窗格上，选择 **实体 > 角色价格**。
3. 展开实体 **角色价格**，然后选择 **字段**。
4. 单击 **新建** 创建名称为 **资源工作位置** 的新字段，然后选择 **选项集** 作为字段类型。 
5. 选择 **使用现有选项集**，选择 **资源工作位置** 选项集，然后单击 **保存**。
6. 重复步骤 1 - 5 将此字段添加到 **角色价格加价** 实体。 
7. 对 **资源工作时间** 选项集重复步骤 1 - 5。

> [!IMPORTANT]
> 将一个字段添加到多个实体时，请在所有实体中使用同一个字段名称。 

> ![将“资源工作位置”添加到“角色价格”](media/RWL-Field.png)

在项目的销售和估算阶段，**常规工作时间** 和 **加班工作时间** 中完成 **本地** 和 **现场** 工作所需工作量的估算用于估算报价单/项目的值。 将把字段 **资源工作位置** 和 **资源工作时间** 添加到估算实体 **报价单明细详细信息**、**合同子项详细信息**、**项目任务**、**项目团队成员** 和 **估算明细**。

1. 在 PSA 中，单击 **设置** > **解决方案**，然后双击 **\<your organization name> 定价维度**。 
2. 在解决方案资源管理器中左侧导航窗格上，选择 **实体 > 报价单明细详细信息**。
3. 展开 **报价单明细详细信息** 实体，然后选择 **字段**。
4. 单击 **新建** 创建名称为 **资源工作位置** 的新字段，然后选择字段类型 **选项集**。 
5. 选择 **使用现有选项集** 和 **资源工作位置**，然后单击 **保存**。
6. 重复步骤 1 - 5 将此字段添加到 **项目合同子项详细信息**、**项目任务**、**项目团队成员** 和 **估算明细** 实体。
7. 对 **资源工作时间** 选项集重复步骤 1 - 6。 

> ![将“资源工作位置”添加到“估算明细”](media/RWL-Default-Value.png)


对于交付和开票，需要对已完成工作准确定价，以便在“项目实际值”中选择其是在 **本地** 还是 **现场** 执行的，以及是在 **常规工作时间** 还是 **加班** 完成的。 应该将 **资源工作位置** 和 **资源工作时间** 字段添加到 **时间条目**、**实际值**、**发票明细详细信息** 和 **日记帐行** 实体。

1. 在 PSA 中，单击 **设置** > **解决方案**，然后双击 **\<your organization name> 定价维度**。
2. 在解决方案资源管理器中左侧导航窗格上，选择 **实体 > 时间条目**。
3. 展开 **报价单明细详细信息** 实体，然后选择 **字段**。
4. 单击 **新建** 创建名称为 **资源工作位置** 的新字段，然后选择 **选项集** 作为字段类型。 
5. 选择 **使用现有选项集**，选择 **资源工作位置** 选项集，然后单击 **保存**。
6. 重复步骤 1 - 5 将此字段添加到 **实际值**、**发票明细详细信息**,和 **日记帐行** 实体。
7. 对 **资源工作时间** 选项集重复步骤 1 - 6。 

> ![将“资源工作位置”添加到“时间条目”](media/RWL-time-entry.png)

这将完成基于选项集的自定义维度所需架构更改。

## <a name="entity-based-custom-pricing-dimensions"></a>基于实体的自定义定价维度

当自定义定价维度是实体时，您将添加维度实体与关键 Project Service 实体之间的 1:N 关系。 如果使用上面的“标准标题”示例，则应该为每位员工分派一个标准标题。 因此，您需要“标准标题”到“可预订资源”的 1:N 关系，或 N:1 关系（如果是从“可预订资源”到“标准标题”创建的）。

1. 在 PSA 中，单击 **设置** > **解决方案**，然后双击 **\<your organization name> 定价维度**。 
2. 在解决方案资源管理器中左侧导航窗格上，选择 **实体 > 标准标题**。
3. 展开 **标准标题** 实体，然后选择 **1:N 关系**。
4. 单击 **新建** 创建名称为 **标准标题到可预订资源** 的 1:N 关系。 输入所需信息，然后单击 **保存**。

> ![将“标准标题”作为引用字段添加到“可预订资源”](media/ST-BR.png)

还需要将“标准标题”添加到 Project Service 的定价实体，如 **角色价格** 和 **角色价格加价**。 还使用 **标准标题** 与 **角色** 实体之间和 **标准标题** 与 **角色价格加价** 实体之间的 1:N 关系完成此操作。

1. 在解决方案资源管理器中左侧导航窗格上，选择 **实体 > 标准标题**。
2. 展开 **标准标题** 实体，然后选择 **1:N 关系**。
3. 单击 **新建** 创建名称为 **标准标题到角色价格** 的 1:N 关系。 输入所需信息，然后单击 **保存**。
4. 重复步骤 1 - 4 以创建 **标准标题** 与 **角色价格加价** 实体之间的 1:N 关系。

在项目的销售和估算阶段，若要为报价单/项目定价，需要为每个标准标题估算工作量。 这意味着需要从“标准标题”到 Project Service 中的以下每个估算实体的 1:N 关系： 

- **报价单明细详细信息**
- **项目合同子项详细信息**
- **项目任务**
- **项目团队成员**
- **估计值明细**

5. 重复步骤 1 - 5 以创建从 **标准标题** 到 **报价单明细详细信息**、**项目合同子项详细信息**、**项目任务**、**项目团队成员** 和 **估算明细** 的 1:N 关系。

> ![将“标准标题”作为引用字段添加到“估算明细”](media/ST-Estimate-Line.png)

在交付和开票阶段，必须在“项目实际值”中为每个标准标题完成的工作准确定价。 这意味着需要从 **标准标题** 到 **时间条目**、**实际值**、**发票明细详细信息** 和 **日记帐行实体** 的 1:N 关系。

6. 重复步骤 1 - 6 创建从 **标准标题** 到 **时间条目**、**实际值**、**发票明细详细信息** 和 **日记帐行实体** 的 1:N 关系。

> ![将“标准标题”作为引用字段添加到“时间条目”](media/ST-Mapping.png)

### <a name="set-up-dimension-value-defaulting-using-the-mappings-features-of-the-platform"></a>使用平台的映射功能设置默认维度值
对于“时间条目”，最好是让系统默认采用记录时间条目的“可预订资源”中“时间条目”内的标准标题。 请执行以下步骤将 1:N 关系中的字段映射从 **可预订资源** 添加到 **时间条目**。

1. 在解决方案资源管理器中左侧导航窗格上，选择 **实体 > 标准标题**。
2. 展开 **标准标题** 实体，然后选择 **1:N 关系**。
3. 双击 **可预订资源到时间条目**。 在 **关系** 页中，单击 **使用映射字段**。 
4. 单击 **新建** 创建 **可预订资源** 实体中的 **标准标题** 字段到 **时间条目** 字段中的 **标准标题** 引用字段的新字段映射。 

> ![设置字段映射以便执行从“可预订资源”到“时间条目”的标准标题默认设置](media/ST-Mapping2.png)


这将完成基于实体的自定义维度所需架构更改。

##  <a name="add-custom-fields-to-forms-views-and-business-rules"></a>向表单、视图和业务规则添加自定义字段

执行所有必需的架构更改之后，下一步是通过将字段添加到窗体和视图，在 UI 中显示这些字段。

1. 打开窗体或视图。 在右侧导航窗格上，选择字段，然后将其拖到窗体区域中。 
2. 如果在编辑视图，请使用右侧导航窗格单击 **添加字段**，在 **字段列表** 对话框中选择所需字段， 然后单击 **确定**。

下表提供需要更新的大量自带窗体和视图的列表（按实体排列），将使用新字段更新这些窗体和视图。 如果这些实体的自定义项中有任何其他视图或窗体，请将新字段也添加到这些视图或窗体。

| Project Service 实体        | 需要新字段的窗体   |需要新字段的视图      |
| ------------------------------|---------------------------------|----------------------------------|
|  角色价格|• 信息 |• 可用的资源类别价格<br> • 资源类别价格关联视图|
|  角色价格加价|• 信息|• 可用角色价格加价<br>• 角色价格加价关联视图|
|  报价单明细详细信息|• 项目信息<br>• 项目快速创建|• 可用的报价单明细详细信息<br>• 合并的报价单明细详细信息<br>• 报价单明细详细信息关联视图|
|  项目合同子项详细信息|• 项目信息<br>• 项目快速创建|• 合并的合同子项详细信息<br>• 可用的合同子项详细信息<br>• 合同子项详细信息关联视图|
|  项目任务|• 信息<br>• 新窗体||
|  项目团队成员|• 信息<br>• 新窗体|• 可用的项目团队成员<br>• 项目团队成员<br>• 项目团队成员关联视图|
|  时间条目|• 信息<br>• 创建时间条目|• 我的按日期列出的时间条目<br>• 我本周的时间条目<br>• 供审批的时间条目|
|  日记帐行|• 信息<br>• 快速创建|• 可用的日记帐行<br>• 日记帐行关联视图|
|  发票明细详细信息|• 信息<br>• 快速创建|• 可用的发票明细详细信息<br>• 应计费发票交易记录<br>• 免费发票交易记录<br>• 发票明细详细信息关联视图<br>• 非应计费发票交易记录|
|  实际值|• 信息<br>• 可用的实际值|• 实际值关联视图|

还可能需要在业务规则中添加自定义字段，具体取决于您已定义的内容。 业务规则 **基于状态的时间条目的可编辑性** 就是一个现成示例。 此规则定义当时间条目处于不可编辑状态（如 **已批准**）时，需要锁定哪些字段。 向此业务规则添加字段，以便在时间条目的状态不是 **草稿** 或 **已返回** 时，锁定字段，使其不可编辑。


[!INCLUDE[footer-include](../includes/footer-banner.md)]